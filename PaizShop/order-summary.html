<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/PaizCorp/PaizShop/PaizShop2.png" sizes="16x16">
    <title>Order Summary - Paiz Shop</title>
    <link rel="stylesheet" href="/PaizCorp/PaizShop/styles.css">
    <style>
        /* Add styles for the popup */
        #discord-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        #discord-popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <h1>Order Summary</h1>
    </header>
    <main>
        <div id="order-summary">
            <!-- Order Summary details will be dynamically inserted here -->
        </div>
        <button id="place-order">Place Order</button>
        <button id="send-to-me">Send to Me</button>
    </main>

    <!-- Popup for Discord username input -->
    <div id="discord-popup">
        <div id="discord-popup-content">
            <h2>Send Order Summary</h2>
            <label for="discord-username">Discord Username:</label>
            <input type="text" id="discord-username" placeholder="Your Discord Username">
            <button id="send-summary">Send</button>
            <button id="close-popup">Cancel</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const orderSummaryDiv = document.getElementById('order-summary');
            const orderDetails = JSON.parse(sessionStorage.getItem('orderDetails'));

            // Display order summary
            orderSummaryDiv.innerHTML = `
                <h2>Order Summary</h2>
                <p>${orderDetails.quantity}x ${orderDetails.item} - ${orderDetails.subtotal} Diamonds</p>
                <hr>
                <p>Subtotal: ${orderDetails.subtotal} Diamonds</p>
                <p>Delivery Fee: ${orderDetails.deliveryFee} Diamonds</p>
                <p>The LoL Tax (3%): ${orderDetails.tax} Diamonds</p>
                <hr>
                <p>Total: ${orderDetails.total} Diamonds</p>
                <p>Paid with: <img src="diamond.png" alt="Diamond Logo" style="height: 20px;"> Diamonds on delivery</p>
            `;

            // Handle Place Order
            const placeOrderButton = document.getElementById('place-order');
            if (placeOrderButton) {
                placeOrderButton.addEventListener('click', function () {
                    const webhookUrl = 'https://discord.com/api/webhooks/1272139292889841677/sBsjI4ABTBTDhayfyDIVDk1cdmQ2Uc4hWeAsS81cj0-GXJEpvXi2g95PIFtbhcFjhYOI'; // Replace with your actual webhook URL
                    sendOrderToDiscord(orderDetails, webhookUrl);
                    alert("Order has been placed!");
                    // Optionally clear the cart or redirect the user
                });
            }

            // Handle "Send to Me" button click
            document.getElementById('send-to-me').addEventListener('click', function () {
                document.getElementById('discord-popup').style.display = 'flex';
            });

            // Handle "Send" button click in the popup
            document.getElementById('send-summary').addEventListener('click', function () {
                const discordUsername = document.getElementById('discord-username').value;
                if (discordUsername) {
                    const orderDetails = JSON.parse(sessionStorage.getItem('orderDetails'));
                    sendOrderToDiscordUser(discordUsername, orderDetails);
                } else {
                    alert('Please enter your Discord username.');
                }
            });

            // Handle "Cancel" button click in the popup
            document.getElementById('close-popup').addEventListener('click', function () {
                document.getElementById('discord-popup').style.display = 'none';
            });

            // Function to send order details to buyer's Discord account
            function sendOrderToDiscordUser(discordUsername, orderDetails) {
                // Implement user ID resolution logic here
                const userId = resolveDiscordUsernameToId(discordUsername); // Placeholder function
                const botToken = 'MTI3NDY0ODk4ODI0Njg3MjE0Nw.G9hi6j.1_lNeter_CrioeKb2mjivPeF4TfT-_XYBn-GCI'; // Replace with your bot token

                if (!userId) {
                    alert("Could not find user with this Discord username!");
                    return;
                }

                const message = {
                    "content": null,
                    "embeds": [
                        {
                            "title": "ðŸ“¦ New Order Placed ðŸ“¦",
                            "color": 5814783,
                            "fields": [
                                {
                                    "name": "ðŸ›’ Order Details",
                                    "value": `- **Item:** ${orderDetails.quantity}x ${orderDetails.item}\n- **Subtotal:** ðŸ’Ž${orderDetails.subtotal} Diamonds\n- **Delivery Fee:** ðŸ’Ž${orderDetails.deliveryFee} Diamonds (if applicable)\n- **Tax (3%):** ðŸ’Ž${orderDetails.tax}\n\n**Total Amount:** ðŸ’Ž${orderDetails.total} Diamonds`
                                },
                                {
                                    "name": "ðŸ‘¤ Minecraft Name",
                                    "value": orderDetails.minecraftName
                                },
                                {
                                    "name": orderDetails.delivery ? "ðŸšš Delivery Option" : "ðŸ“ Pickup Option",
                                    "value": orderDetails.delivery ? `- **Delivery Coordinates:** X: ${orderDetails.coordinates.x}, Y: ${orderDetails.coordinates.y}, Z: ${orderDetails.coordinates.z}` : `- **Pickup Address:** ${orderDetails.address}`
                                }
                            ],
                            "footer": {
                                "text": "Order placed on Paiz Shop"
                            }
                        }
                    ],
                    "attachments": []
                };

                fetch(`https://discord.com/api/v10/users/${userId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bot ${botToken}`
                    },
                    body: JSON.stringify(message)
                }).then(response => {
                    if (response.ok) {
                        alert('Order summary sent to your Discord account!');
                        document.getElementById('discord-popup').style.display = 'none';
                    } else {
                        alert('Failed to send order summary to Discord.');
                    }
                }).catch(error => {
                    alert('Error:', error);
                });
            }

            // Function to resolve Discord username to user ID (placeholder)
            function resolveDiscordUsernameToId(username) {
                // Replace this with actual logic to resolve username to user ID
                // This could involve using a bot to lookup users in a server or a database
                // For demonstration purposes, this returns a placeholder ID
                return '123456789012345678'; // Placeholder user ID
            }
        });

        // Function to send order details to Discord webhook
        function sendOrderToDiscord(orderDetails, webhookUrl) {
            const embed = {
                "content": null,
                "embeds": [
                    {
                        "title": "ðŸ“¦ New Order Placed ðŸ“¦",
                        "color": 5814783,
                        "fields": [
                            {
                                "name": "ðŸ›’ Order Details",
                                "value": `- **Item:** ${orderDetails.quantity}x ${orderDetails.item}\n- **Subtotal:** ðŸ’Ž${orderDetails.subtotal} Diamonds\n- **Delivery Fee:** ðŸ’Ž${orderDetails.deliveryFee} Diamonds (if applicable)\n- **Tax (3%):** ðŸ’Ž${orderDetails.tax}\n\n**Total Amount:** ðŸ’Ž${orderDetails.total} Diamonds`
                            },
                            {
                                "name": "ðŸ‘¤ Minecraft Name",
                                "value": orderDetails.minecraftName
                            },
                            {
                                "name": orderDetails.delivery ? "ðŸšš Delivery Option" : "ðŸ“ Pickup Option",
                                "value": orderDetails.delivery ? `- **Delivery Coordinates:** X: ${orderDetails.coordinates.x}, Y: ${orderDetails.coordinates.y}, Z: ${orderDetails.coordinates.z}` : `- **Pickup Address:** ${orderDetails.address}`
                            }
                        ],
                        "footer": {
                            "text": "Order placed on Paiz Shop"
                        }
                    }
                ],
                "attachments": []
            };

            fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(embed)
            }).then(response => {
                if (response.ok) {
                    console.log('Order sent to Discord!');
                } else {
                    console.error('Failed to send order to Discord.');
                }
            }).catch(error => {
                console.error('Error:', error);
            });
        }
    </script>
</body>
</html>
